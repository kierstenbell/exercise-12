---
title: "exercise-12"
output: html_document
date: "2024-04-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Preliminaries
- Using the {tidyverse} read_tsv() function, load the “Mammal_lifehistories_v2.txt” dataset from this [URL](https://raw.githubusercontent.com/difiore/ada-2024-datasets/main/Mammal_lifehistories_v2.txt) as a “tibble” named d. As discussed in class, this is dataset that compiles life history and other variables for over 1400 species of placental mammals from 17 different Orders.
- Do a bit of exploratory data analysis with this dataset, e.g., using the {skimr} package. Which of the variables are categorical and which are numeric?

    - Categorical variables: order, family, Genus, and species
    - Numeric variables: mass(g), gestation(mo), newborn(g), weaning(mo), wean mass(g), AFR(mo) max.life(mo), litter size, litters/year, refs

```{r cars}
# Load libraries 
library(skimr)
library(tidyverse)
library(naniar)

# Grab file
f <- "https://raw.githubusercontent.com/difiore/ada-2024-datasets/main/Mammal_lifehistories_v2.txt"
d <- read_tsv(f, col_names = TRUE)
skim (d)
head(d)

```
#### Step 1 
- Replace all values of -999 (the authors’ code for missing data) with NA.

```{r}
# use replace_with_na_all() function from the {naniar} to replace -999 with NA.
d <- replace_with_na_all(data = d, condition = ~.x == -999.00)

```

#### Step 2 
- Drop the variables **litter size** and **refs**.

```{r}
d <- d %>%
  select(-c(`litter size`, refs))

# double check 
glimpse(d) # litter size and refs are dropped 
```

#### Step 3
- Log transform all of the other numeric variables

```{r}
# The mutate(across(where(is.numeric))) looks for variables that are numeric and log transforms. NOTE. Variable names DO NOT CHANGE. 
d <- d %>% 
  mutate(across(where(is.numeric), ~log(.)))

head(d)
```


#### Step 4 
- Regress the (now log transformed) age [gestation(mo), weaning(mo), AFR(mo) (age at first reproduction), and max. life(mo) (maximum lifespan)] and mass [newborn(g) and wean mass(g)] variables on (now log transformed) overall body mass(g) and add the residuals to the dataframe as new variables (relGest, relWean, relAFR, relLife, relNewbornMass, and relWeaningMass).
```{r}
# Regress the selected variables on log transformed body mass, called mass(g)
# Must include na.action = na.include in order to include NA to make sure the matrix fits 
m1 <- lm(`gestation(mo)` ~ `mass(g)`, data = d, na.action = na.exclude)
m2 <- lm(`weaning(mo)` ~ `mass(g)`, data = d, na.action = na.exclude)
m3 <- lm(`AFR(mo)` ~ `mass(g)`, data = d, na.action = na.exclude)
m4 <- lm(`max. life(mo)` ~ `mass(g)`, data = d, na.action = na.exclude)
m5 <- lm(`newborn(g)` ~ `mass(g)`, data = d, na.action = na.exclude)
m6 <- lm(`wean mass(g)` ~ `mass(g)`, data = d,  na.action = na.exclude)


# Need to call resid(). Doing m1$residuals did not include NA...
d <- d %>%
  mutate(
    relGest = resid(m1),
    relWean = resid(m2), 
    relAFR = resid(m3),
    relLife = resid(m4),
    relNewbornMass = resid(m5), 
    relWeaningMass = resid(m6)
  )

```

#### Step 5
- Plot residuals of max lifespan (relLife) in relation to Order. Which mammalian orders have the highest residual lifespan?

    - Based on maximum values, the mammalian orders with the highest residual lifespan: (1) primates, (2) rodentia, and (3) xenarthra
    - Based on median values, the mammalian orders with the highest residual lifespan: (1) primates, (2) pholidota, and (3) Scandentia
    
- Plot residuals of newborn mass (relNewbornMass) in relation to Order. Which mammalian orders have the have highest residual newborn mass?

    - Based on maximum values, the mammalian orders with the highest residual newborn mass: (1) cetacea, (2) carnivora, (3) artiodactyla
    - Based on median values, the mammalian orders with the highest residual newborn mass: (1) macroscelidea, (2) cetacea, (3) Hhracoidea
    
- Plot residuals of weaning mass (relWeaningMass) in relation to Order. Which mammalian orders have the have highest relative weaning mass?

    - Based on maximum values, mammalian orders with the highest relative weaning mass: (1) carnivora, (2) perissodactyla, (3) cetacea
    - Based on median values, the mammalian orders with the highest relative weaning mass: (1) perissodactyla, (2) insectivora, (3) cetacea
    
```{r}
# Plot: Residuals of max lifespan (relLife) in relation to Order
p_relLife <- ggplot(data = d, aes(x = order, y = relLife)) + 
  geom_boxplot() + 
  geom_jitter(alpha = 0.05) + # makes the dots more transparent 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Order") + ylab("Residual Log(Max Lifespan)")
p_relLife

# To double check: max lifespan::order; use R's 5 number summary function fivenum() to definitively tell which orders have the highest max
relLife_5NumSum <- d %>%
  group_by(order) %>%
  summarise(n = n(),
            min = fivenum(relLife)[1],
            Q1 = fivenum(relLife)[2],
            median = fivenum(relLife)[3],
            Q3 = fivenum(relLife)[4],
            max = fivenum(relLife)[5])
relLife_5NumSum

# Plot: Residuals of newborn mass (relNewbornMass) in relation to Order
p_relNewbornMass <- ggplot(data = d, aes(x = order, y = relNewbornMass)) + 
  geom_boxplot() + 
  geom_jitter(alpha = 0.05) + # makes the dots more transparent 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Order") + ylab("Residual Log(Newborn Mass (g)")
p_relNewbornMass

# It is difficult to tell what some of the maxes were on the graph, so using R's 5 number summary function fivenum() to definitively tell which orders have the highest max
relNewbornMass_5NumSum <- d %>%
  group_by(order) %>%
  summarise(n = n(),
            min = fivenum(relNewbornMass)[1],
            Q1 = fivenum(relNewbornMass)[2],
            median = fivenum(relNewbornMass)[3],
            Q3 = fivenum(relNewbornMass)[4],
            max = fivenum(relNewbornMass)[5])
relNewbornMass_5NumSum

# Plot: Residuals of weaning mass (relWeaningMass) in relation to Order
p_relWeaningMass <- ggplot(data = d, aes(x = order, y = relWeaningMass)) + 
  geom_boxplot() + 
  geom_jitter(alpha = 0.05) + # makes the dots more transparent 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Order") + ylab("Residual Log(Weaning Mass (g))")
p_relWeaningMass

# To double check plots 
relWeaningMass_5NumSum <- d %>%
  group_by(order) %>%
  summarise(n = n(),
            min = fivenum(relWeaningMass)[1],
            Q1 = fivenum(relWeaningMass)[2],
            median = fivenum(relWeaningMass)[3],
            Q3 = fivenum(relWeaningMass)[4],
            max = fivenum(relWeaningMass)[5])
relWeaningMass_5NumSum
```

#### Step 6
- Run models and a model selection process to evaluate what (now log transformed) variables best predict each of the two response variables, max. life(mo) and AFR(mo), from the set of the following predictors: gestation(mo), newborn(g), weaning(mo), wean mass(g), litters/year, and overall body mass(g).
- For each of the two response variables, indicate what is the best model overall based on AICc and how many models have a delta AICc of 4 or less.

    - See below. For `max. life(mo)` m4 is the best model, and it is the only model that has a delta AICc of 4 or less. For `AFR(m0)`, lm4 is the best model, and it is the only model that has  a delta AICc of 4 or less. 
    
- What variables, if any, appear in all of this set of “top” models?

    - The variables that appear in all the sets are `gestation(mo)`, `litters/year`, and `weaning(mo)`. 
    
- Calculate and plot the model-averaged coefficients and their CIs across this set of top models.

```{r}
# First, drop NAs
# Drop NAs for the response variable max. life(mo)
d_maxLife <- d %>%
  drop_na(`max. life(mo)`,`gestation(mo)`, `newborn(g)`, `weaning(mo)`, `wean mass(g)`, `litters/year`, `mass(g)`)

# Forward Selection Regression Modeling for max. life(mo)
# max. life(mo)
m0 <- lm(data = d_maxLife, `max. life(mo)` ~ 1)
summary(m0)

add1(m0, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")
# All values would add explanatory power, but gestation(mo) is associated with the highest new F statistic
m1 <- update(m0, formula = . ~ . + `gestation(mo)`)
summary(m1)

add1(m1, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")
# All values would add explanatory power, but `litters/year` is associated with the highest new F statistic
m2 <- update(m1, formula = . ~ . + `litters/year`)
summary(m2)

add1(m2, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")
# Newborn(g), wean mass(g), and mass(g) are all significant. Mass(g) has highest F value
m3 <- update(m2, formula = . ~ . + `mass(g)`)
summary(m3)

add1(m3, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")
# Only weaning(mo) is significant!
m4 <- update(m3, formula = . ~ . + `weaning(mo)`)
summary(m4)

add1(m4, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")
# No more terms are significant! There are not any more predictors that would improve the explanatory power of the model.
# m4 is our best model for max life (mo)

# ...Using AIC to select
library(MASS)

# Start with the full model 
m.full <- lm(data = d_maxLife, `max. life(mo)` ~ `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`)
s <- stepAIC(m.full, scope = .~., direction = "both")
summary(s)
# ... this confirms m4 as our model since the same terms as before, `gestation(mo)`, `weaning(mo)`, `litters/year`, and `mass(g)` add explanatory power to the model. 

library(AICcmodavg)
aictab(list(m0, m1, m2, m3, m4), c("m0", "m1", "m2", "m3", "m4"))


# Repeat for AFR (mo)
# Drop NAs for the response variable AFR(mo)
d_AFR <- d %>%
  drop_na(`AFR(mo)`,`gestation(mo)`, `newborn(g)`, `weaning(mo)`, `wean mass(g)`, `litters/year`, `mass(g)`)

# Create base linear model
lm0 <- lm(data = d_AFR, `AFR(mo)` ~ 1)
summary(m0)

add1(lm0, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")

# All values would add explanatory power, but `litters/year` is associated with the highest new F statistic
lm1 <- update(lm0, formula = . ~ . + `litters/year`)
summary(lm1)

add1(lm1, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")

# All values would add explanatory power, but `gestation(mo)` is associated with the highest new F statistic
lm2 <- update(lm1, formula = . ~ . + `gestation(mo)`)
summary(lm2)

add1(lm2, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")

# `weaning(mo)`, `wean mass(g)`, `mass(g)` would add explanatory power, but `wean mass(g)` is associated with the highest new F statistic
lm3 <- update(lm2, formula = . ~ . + `wean mass(g)`)
summary(lm3)

add1(lm3, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")

# Only `weaning(mo)` is significant
lm4 <- update(lm3, formula = . ~ . + `weaning(mo)`)
summary(lm4)

add1(lm4, scope = . ~ . + `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, test = "F")
# No more significance! There are not any more predictors that would improve the explanatory power of the model. 
# lm4 is the best model for AFR(m0)
aictab(list(lm0, lm1, lm2, lm3, lm4), c("lm0", "lm1", "lm2", "lm3", "lm4"))
detach(package:AICcmodavg)

# ...Using AIC to select
# Start with the full model 
m.full <- lm(data = d_AFR, `AFR(mo)` ~ `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`)
s <- stepAIC(m.full, scope = .~., direction = "both")
summary(s)
# ... this confirms lm4 as our model since the same terms as before, `gestation(mo)`, `weaning(mo)`, `litters/year`, and `mass(g)` add explanatory power to the model. 
detach(package:MASS)
```

```{r}
# Using {MuMIn} package, we calculate the model-averaged coefficients and their CIs across this set of top models.
library(MuMIn)
# Max life (mo)
# Using full data set
m.full <- lm(data = d_maxLife, `max. life(mo)` ~ `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, na.action = "na.fail")

# dredge from {MuMIn} explores subsets of a given global model in an automated way.
mods <- dredge(m.full, beta = "none", m.lim = c(0, 4))

# dredge() does not actually store the model results; use model.avg() function returns a “summary.averaging” object.
# average beta coefficients for models in the 95% confidence set, i.e., for cumulative AIC weights up to 95%:
(mods.avg <- summary(model.avg(mods, subset = cumsum(weight) <= 0.95, fit = TRUE)))

#use the confint() function for confidence intervals for the averaged average beta coefficients for models in the 95% CI set
confint(mods.avg)

# Using {MuMIn} package, we can also plot this
plot(mods.avg, full = TRUE, intercept = FALSE, main = "Model-averaged Coefficients for Maximum Life (months)")

# Age at first reproduction (AFR)
m.full <- lm(data = d_AFR, `AFR(mo)` ~ `gestation(mo)` + `newborn(g)` + `weaning(mo)` + `wean mass(g)` + `litters/year` + `mass(g)`, na.action = "na.fail")

# dredge from {MuMIn}
mods <- dredge(m.full, beta = "none", m.lim = c(0, 4))

(mods.avg <- summary(model.avg(mods, subset = cumsum(weight) <= 0.95, fit = TRUE)))

#use the confint() function for confidence intervals for the averaged average beta coefficients for models in the 95% CI set
confint(mods.avg)

# Using {MuMIn} package, we can also plot this
plot(mods.avg, full = TRUE, intercept = FALSE, main = "Model-averaged Coefficients for \nAge at First Reproduction (months)")
```




